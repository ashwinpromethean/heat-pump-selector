{% extends "base.html" %}

{% block content %}
{% if error %}
<div class="alert alert-danger" role="alert">
    <i class="fas fa-exclamation-triangle me-2"></i>{{ error }}
</div>
{% else %}
<div class="alert alert-success" role="alert">
    <i class="fas fa-check-circle me-2"></i>Loaded {{ "{:,}".format(data_count | default(0)) }} rows from data file
</div>
{% endif %}

<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-search me-2"></i>Heat Pump Selection Criteria
                </h5>
            </div>
            <div class="card-body">
                <form id="searchForm">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="refrigerant" class="form-label">Refrigerant</label>
                            <select class="form-select" id="refrigerant" name="refrigerant" required>
                                {% for ref in refrigerants %}
                                <option value="{{ ref }}">{{ ref.upper() }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="heat_pump_type" class="form-label">Heat Pump Type</label>
                            <select class="form-select" id="heat_pump_type" name="heat_pump_type" onchange="toggleInputs()">
                                <option value="Air Source">Air Source</option>
                                <option value="Water Source">Water Source</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="qo" class="form-label">Heating Capacity Qo (kW)</label>
                            <input type="number" class="form-control" id="qo" name="qo" value="56.4" step="0.1" required>
                        </div>
                        
                        <!-- Air Source inputs -->
                        <div class="col-md-4" id="ambient_temp_group">
                            <label for="ambient_temp" class="form-label">Ambient Air Temperature (°C)</label>
                            <input type="number" class="form-control" id="ambient_temp" name="ambient_temp" value="35.0" step="0.5">
                        </div>
                        
                        <!-- Water Source inputs -->
                        <div class="col-md-4" id="cold_water_temp_group" style="display: none;">
                            <label for="cold_water_temp" class="form-label">Chilled Water Temperature (°C)</label>
                            <input type="number" class="form-control" id="cold_water_temp" name="cold_water_temp" value="7.0" step="0.5">
                        </div>
                        
                        <div class="col-md-4">
                            <label for="hot_water_temp" class="form-label">Hot Water Temperature (°C)</label>
                            <input type="number" class="form-control" id="hot_water_temp" name="hot_water_temp" value="45.0" step="0.5" required>
                        </div>
                    </div>
                    
                    <div id="calculated_values" class="row mb-3">
                        <!-- Will be populated by JavaScript -->
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="k" class="form-label">Number of Results</label>
                            <input type="number" class="form-control" id="k" name="k" value="5" min="1" max="50">
                        </div>
                    </div>
                    
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="fas fa-search me-2"></i>Find Closest Heat Pumps
                        </button>
                    </div>
                </form>
                
                <div class="loading text-center mt-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Searching...</span>
                    </div>
                    <p class="mt-2">Searching for heat pumps...</p>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="fas fa-cog me-2"></i>Matching Options
                </h6>
            </div>
            <div class="card-body">
                <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" id="exact_tc" name="exact_tc">
                    <label class="form-check-label" for="exact_tc">
                        Require exact TC match?
                    </label>
                </div>
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="exact_to" name="exact_to">
                    <label class="form-check-label" for="exact_to">
                        Require exact TO match?
                    </label>
                </div>
                
                <div class="accordion" id="weightsAccordion">
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#weightsCollapse">
                                Advanced Weights
                            </button>
                        </h2>
                        <div id="weightsCollapse" class="accordion-collapse collapse">
                            <div class="accordion-body">
                                <div class="mb-2">
                                    <label for="w_qo" class="form-label">Weight Qo</label>
                                    <input type="number" class="form-control form-control-sm" id="w_qo" name="w_qo" value="1.0" min="0" step="0.1">
                                </div>
                                <div class="mb-2">
                                    <label for="w_tc" class="form-label">Weight TC</label>
                                    <input type="number" class="form-control form-control-sm" id="w_tc" name="w_tc" value="1.0" min="0" step="0.1">
                                </div>
                                <div class="mb-2">
                                    <label for="w_to" class="form-label">Weight TO</label>
                                    <input type="number" class="form-control form-control-sm" id="w_to" name="w_to" value="1.0" min="0" step="0.1">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="results-section mt-4">
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0">
                <i class="fas fa-list me-2"></i>Search Results
            </h5>
            <button class="btn btn-success btn-sm" id="downloadBtn">
                <i class="fas fa-download me-1"></i>Download CSV
            </button>
        </div>
        <div class="card-body">
            <div id="results-message"></div>
            <div class="table-responsive">
                <table class="table table-striped table-hover" id="resultsTable">
                    <thead class="table-dark">
                        <tr id="tableHeader"></tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let lastSearchData = null;

function toggleInputs() {
    const heatPumpType = document.getElementById('heat_pump_type').value;
    const ambientGroup = document.getElementById('ambient_temp_group');
    const coldWaterGroup = document.getElementById('cold_water_temp_group');
    
    if (heatPumpType === 'Water Source') {
        ambientGroup.style.display = 'none';
        coldWaterGroup.style.display = 'block';
    } else {
        ambientGroup.style.display = 'block';
        coldWaterGroup.style.display = 'none';
    }
    
    updateCalculatedValues();
}

function updateCalculatedValues() {
    const heatPumpType = document.getElementById('heat_pump_type').value;
    const hotWaterTemp = parseFloat(document.getElementById('hot_water_temp').value) || 45.0;
    const calculatedDiv = document.getElementById('calculated_values');
    
    let tc, to;
    
    if (heatPumpType === 'Water Source') {
        const coldWaterTemp = parseFloat(document.getElementById('cold_water_temp').value) || 7.0;
        tc = hotWaterTemp + 5.0;
        to = coldWaterTemp - 5.0;
    } else {
        const ambientTemp = parseFloat(document.getElementById('ambient_temp').value) || 35.0;
        tc = hotWaterTemp + 5.0;
        to = ambientTemp - 12.0;
    }
    
    calculatedDiv.innerHTML = `
        <div class="col-md-6">
            <div class="info-box">
                <strong>Calculated TC:</strong> ${tc.toFixed(1)}°C (Hot water + 5°C)
            </div>
        </div>
        <div class="col-md-6">
            <div class="info-box">
                <strong>Calculated TO:</strong> ${to.toFixed(1)}°C (${heatPumpType === 'Water Source' ? 'Chilled water - 5°C' : 'Ambient - 12°C'})
            </div>
        </div>
    `;
}

document.getElementById('searchForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const data = Object.fromEntries(formData.entries());
    
    // Convert checkboxes
    data.exact_tc = document.getElementById('exact_tc').checked;
    data.exact_to = document.getElementById('exact_to').checked;
    
    lastSearchData = data;
    
    document.querySelector('.loading').style.display = 'block';
    document.querySelector('.results-section').style.display = 'none';
    
    try {
        const response = await fetch('/api/search', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        document.querySelector('.loading').style.display = 'none';
        
        if (result.success) {
            displayResults(result);
            document.querySelector('.results-section').style.display = 'block';
        } else {
            alert(result.message);
        }
    } catch (error) {
        document.querySelector('.loading').style.display = 'none';
        alert('Error occurred while searching: ' + error.message);
    }
});

function displayResults(result) {
    const messageDiv = document.getElementById('results-message');
    const tableHeader = document.getElementById('tableHeader');
    const tableBody = document.getElementById('tableBody');
    
    messageDiv.innerHTML = `
        <div class="alert alert-success">
            <i class="fas fa-check-circle me-2"></i>Found ${result.count} matching heat pump(s)
            <br><small>TC: ${result.tc.toFixed(1)}°C, TO: ${result.to.toFixed(1)}°C</small>
        </div>
    `;
    
    if (result.results.length > 0) {
        // Create table header
        const headers = Object.keys(result.results[0]);
        tableHeader.innerHTML = headers.map(header => `<th>${header}</th>`).join('');
        
        // Create table body
        tableBody.innerHTML = result.results.map(row => {
            return '<tr>' + headers.map(header => {
                let value = row[header];
                if (typeof value === 'number') {
                    value = value.toFixed(3);
                }
                return `<td>${value || ''}</td>`;
            }).join('') + '</tr>';
        }).join('');
    }
}

document.getElementById('downloadBtn').addEventListener('click', async function() {
    if (!lastSearchData) {
        alert('No search results to download');
        return;
    }
    
    try {
        const response = await fetch('/api/download', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(lastSearchData)
        });
        
        if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = 'heat_pump_results.csv';
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
        } else {
            const result = await response.json();
            alert(result.message || 'Error downloading file');
        }
    } catch (error) {
        alert('Error downloading file: ' + error.message);
    }
});

// Initialize form inputs and calculated values
document.addEventListener('DOMContentLoaded', function() {
    // Add event listeners for real-time calculation updates
    document.getElementById('hot_water_temp').addEventListener('input', updateCalculatedValues);
    document.getElementById('ambient_temp').addEventListener('input', updateCalculatedValues);
    document.getElementById('cold_water_temp').addEventListener('input', updateCalculatedValues);
    
    // Initialize
    toggleInputs();
    updateCalculatedValues();
});
</script>
{% endblock %}
